{% extends "webapp/base.html" %}
{% load staticfiles %}
{% load i18n %}


{% block custom_css %}
    <link href="{% static 'webapp/css/bootstrap-select.min.css' %}" rel="stylesheet">
    <link href="{% static 'webapp/css/slider.css' %}" rel="stylesheet">
{% endblock %}


{% block custom_js %}
    <script src="{% static 'webapp/js/bootstrap-slider.js' %}"></script>
    <script src="{% static 'webapp/js/bootstrap-select.min.js' %}"></script>
    <script src="{% static 'webapp/js/repeatable-fields.js' %}"></script>
    <script src="{% static 'webapp/js/jquery-ui-1.10.4.custom.min.js' %}"></script>
    <script src="{% static 'webapp/js/ajax-image-upload.js' %}"></script>
    <script type="text/javascript">
        var settings;
        $().ready(function () {
            $('select').selectpicker(); //TODO ¿Poner esto en toda la web y ya está?
            $('.slider').slider();
            jQuery(function () {
                jQuery('.repeat').each(function () {
                    settings = jQuery(this).repeatable_fields({
                        wrapper: '.repeatable-wrapper',
                        container: '.repeatable-container',
                        row: '.repeatable-row',
                        add: '.repeatable-add',
                        remove: '.repeatable-remove',
                        move: '.repeatable-move',
                        template: '.repeatable-template',
                        is_sortable: true,
                        before_add: null,
                        before_remove: null,
                        after_remove: null,
                        after_add: function (container, new_row) {
                            new_row.find(".ingredient-input").focus();
                        }
                    });
                });
            });
        });
    </script>
    <script>
        $().ready(function () {
            // Drag&Drop for main picture
            var mainPicture = $("#main-picture");
            activateDragAndDrop(mainPicture, "{% url 'upload' %}", function (returndata) {
                var response = $.parseJSON(returndata);
                //TODO validar y tal
                $("#main-picture").css('background-image', 'url(' + response.url + ')');
                $("#main-picture-indicator").hide();

                // Guardar la info en un campo oculto
                var input_id = "#id_{{ form.main_picture_id.name }}";
                $(input_id).val(response.id);
            });

            // Drag&Drop for gallery
            var gallery = $("#gallery");
            activateDragAndDrop(gallery, "{% url 'upload' %}", function (returndata) {
                var response = $.parseJSON(returndata);
                $("#gallery").append('<div class="col-sm-3 gallery-item"><img class="img-rounded" src="' + response.url + '"></div>');

                // Guardar la info en un campo oculto
                var input_id = "#id_{{ form.pictures_ids_list.name }}";
                //TODO este campo es difícil de limpiar si se quiere quitar una foto de la lista
                var current_val = $(input_id).val();
                $(input_id).val(current_val + ";" + response.id);
            });

            $(".step-list").on("click", ".step-picture", function (event) {
                var stepPicture = $(this);
                //TODO mostrar un modal
                var $modal = $("#modal-picture");
                $modal.modal("show");
                var $gallery = $modal.find("#gallery-modal");
                $gallery.empty();

                var urls = [];
                $("#gallery").find(".gallery-item").each(function (index, Element) {
                    urls.push($(Element).find("img").attr("src"))
                });

                for (var i = 0; i < urls.length; i++) {
                    $gallery.append('<div class="col-sm-3 gallery-item"><img class="img-rounded" src="' + urls[i] + '"></div>');
                }

                $gallery.find(".gallery-item").click(function (e) {
                    var url = $(this).find("img").attr("src")

                    var $control = stepPicture.children(".step-picture-add");
                    var $pic = stepPicture.children("img");

                    $pic.attr("src", url);
                    $pic.show();
                    $control.hide();

                    $modal.modal("hide");
                });
            });

        });
    </script>
    <script>
        $().ready(function () {
            $("#recipe-form").submit(function (e) {
                var ingredients= [];
                $(".ingredient-input").each(function (index, Element) {
                    var ingredient = $(Element).val();
                    if(ingredient){
                        ingredients.push(ingredient);
                    }
                });
                var string = ingredients.join(";");
                var list_id = "#id_{{ form.ingredients_list.name }}";
                $(list_id).val(string);
            });
        });
    </script>
{% endblock %}

{% block container %}
<div class="panel panel-default">
<div class="panel-body">
    <form role="form well well-lg" id="recipe-form" class="form-horizontal" method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {% comment %}TODO: poner cada error en su campo
    {% endcomment %}
    {% for field in form %}
        {% for error in field.errors %}
            <div class="alert alert-danger">{{ error|escape }}</div>
        {% endfor %}
    {% endfor %}

    {{ form.non_field_errors }}

    <h3 class="col-lg-offset-1">Basic information</h3>
    <fieldset class="col-sm-10 col-sm-offset-1" style="padding: 20px 100px">

        <!-- Title -->
        <div class="form-group">
            <div class="col-sm-12">
                <input type="text" class="form-control input-xlg" placeholder="Name your recipe"
                       name="{{ form.title.name }}" id="id_{{ form.title.name }}"
                       value="{{ form.title.value | default_if_none:'' }}">
            </div>
        </div>

        <!-- Main Image -->
        <input type="hidden" id="id_{{ form.main_picture_id.name }}" name="{{ form.main_picture_id.name }}">
        <div class="form-group">
            <div class="col-sm-12">
                <div class="main-picture drop-target" id="main-picture">
                    <div id="main-picture-indicator">
                        <p>Add main picture</p>
                        <span class="glyphicon glyphicon-camera"></span>

                        <p>Drag and drop an image here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gallery -->
        <!-- TODO Cuando se vuelve a la página, por ejemplo yendo atrás, los campos del formulario están rellenos, incluído los hidden, pero las fotos obviamente no se muestran. Algo hay que hacer con eso -->
        <input type="hidden" id="id_{{ form.pictures_ids_list.name }}" name="{{ form.pictures_ids_list.name }}">
        <!-- TODO con ciertos tamaños de imagen se buggea y la cuadrícula se va a tomar viento -->
        <div class="form-group">
            <div class="col-sm-12">
                <div class="row gallery drop-target" id="gallery">
                    <!-- Gallery item -->
                    {% comment %}<div class="col-sm-3 gallery-item">
                        <img class="img-rounded"
                             src="http://www.cocinillas.es/wp-content/uploads/2011/05/DSC08380-1600x1200.jpg">
                    </div>{% endcomment %}
                    <div id="gallery-indicator">
                        <p>Add more pictures</p>
                        <span class="glyphicon glyphicon-plus"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description -->
        <div class="form-group">
            <div class="col-sm-12">
                <!-- <label for="id_{{ form.description.name }}"
               class="col-sm-2 ">{{ form.description.label }}</label> -->
                <textarea class="form-control input-lg"
                          placeholder="Write a short description. What is your recipe about?"
                          rows="4"
                          name="{{ form.description.name }}" id="id_{{ form.description.name }}"
                        >{{ form.description.value | default_if_none:'' }}</textarea>
            </div>
        </div>
    </fieldset>

    <span class="clearfix"></span>

    <h3 class="col-lg-offset-1">How to make it</h3>
    <fieldset class="col-sm-10 col-sm-offset-1" style="padding: 20px 100px">
        <!-- Ingredients -->
        <h4>Ingredients list</h4>

        <input type="hidden" id="id_{{ form.ingredients_list.name }}" name="{{ form.ingredients_list.name }}">
        <div class="repeat">
            <div class="form-group repeatable-wrapper">
                <div class="repeatable-container">
                    <!-- ingredient-item -->
                    <div class="form-group ingredient-item repeatable-row repeatable-template">
                        <div class="col-sm-8 col-sm-offset-2">
                            <div class="input-group">
                            <span class="input-group-addon repeatable-move"><span
                                    class="glyphicon glyphicon-sort"></span> </span>
                                <input type="text" class="form-control ingredient-input"
                                       name="ingredient[{row-count-placeholder}]"
                                        >
                            <span class="input-group-btn ingredient-remove">
                                <button class="btn btn-default repeatable-remove" type="button"><span
                                        class="glyphicon glyphicon-remove"></span></button>
                            </span>
                            </div>
                        </div>
                    </div>
                    <!-- /ingredient-item -->

                </div>
                <div class="form-group ingredient-item ">
                    <div class="col-sm-8 col-sm-offset-2">
                        <span class="form-control repeatable-add">Add an ingredient…</span>
                    </div>
                </div>
            </div>
        </div>

        <h4>Step by step</h4>

        <div class="repeat">
            <div class="form-group repeatable-wrapper step-list">
                <div class="repeatable-container">
                    <div class="repeatable-row repeatable-template">
                        <div class="form-group step">
                            <div class="col-sm-1">
                                <span>{row-number-placeholder}</span>
                            </div>
                            <div class="col-sm-9">
                                <textarea class="form-control input-lg"
                                          placeholder="What is the first step?…"
                                          rows="4"
                                          name="step" id="id_step"
                                        ></textarea>
                            </div>
                            <div class="col-sm-2 step-picture">
                                <a class="btn btn-default step-picture-add"><span
                                        class="glyphicon glyphicon-camera"></span></a>
                                <img class="img-rounded"
                                     src="" style="display: none">
                            </div>
                        </div>
                        <hr>
                    </div>
                </div>
                <div class="form-group step">
                    <div class="col-sm-1">
                        <span>+</span>
                    </div>
                    <div class="col-sm-9">
                        <textarea class="form-control input-lg repeatable-add"
                                  placeholder="What is the first step?…"
                                  rows="4"
                                  name="step" id="id_step"
                                ></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modal-picture" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">Pick a picture</h4>
                    </div>
                    <div class="modal-body">
                        <div class="col-sm-12">
                            <div class="row gallery" id="gallery-modal">
                                <!-- Gallery item -->
                                {% comment %}<div class="col-sm-3 gallery-item">
                                    <img class="img-rounded"
                                         src="http://www.cocinillas.es/wp-content/uploads/2011/05/DSC08380-1600x1200.jpg">
                                </div>{% endcomment %}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <h5>Additional notes</h5>

        <div class="form-group">
            <div class="col-sm-12">
                <textarea class="form-control input-lg"
                          placeholder="Anything else you want to point out about your recipe?"
                          rows="3"
                          name="step" id="id_step"
                        ></textarea>
            </div>
        </div>
    </fieldset>

    <span class="clearfix"></span>

    <h3 class="col-lg-offset-1">Extra information</h3>
    <fieldset class="col-sm-10 col-sm-offset-1" style="padding: 20px 50px">

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">Preparation time</label>

                    <div class="col-sm-5">
                        <div class="input-group">
                            <input type="number" class="form-control" placeholder="minutes">
                            <span class="input-group-addon"><span
                                    class="glyphicon glyphicon-time"></span> </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">Cooking time</label>

                    <div class="col-sm-5">
                        <div class="input-group">
                            <input type="number" class="form-control" placeholder="minutes">
                            <span class="input-group-addon"><span
                                    class="glyphicon glyphicon-time"></span> </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">Serves</label>

                    <div class="col-sm-8">
                        <input type="text" class="form-control" placeholder="'Two persons' or 'Five units'">
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">Difficulty</label>

                    <div class="col-sm-6">
                        <select class="form-control">
                            <option>Easy</option>
                            <option>Medium</option>
                            <option>Hard</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">Temporality</label>

                    <div class="col-sm-8">
                        <select class="form-control show-tick" data-live-search="true" multiple>
                            <option>Christmas</option>
                            <option>Summer</option>
                            <option>St. Valentine's</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">Food type</label>

                    <div class="col-sm-6">
                        <select class="form-control show-tick">
                            <option>Breakfast</option>
                            <option>Desert</option>
                            <option>Drink</option>
                            <option>...</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">Special conditions</label>

                    <div class="col-sm-8">
                        <select class="form-control show-tick" data-live-search="true" multiple>
                            <option>Celiac</option>
                            <option>Vegetarian</option>
                            <option>Diabetic</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">Language</label>

                    <div class="col-sm-6">
                        <select class="form-control show-tick">
                            <option>Spanish</option>
                            <option>English</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">Free tags</label>

                    <div class="col-sm-8">
                        <input type="text" class="form-control" placeholder="Comma separated tags">
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="form-group">
                    <label class="col-sm-4 control-label">Nationality</label>

                    <div class="col-sm-6">
                        <input type="text" class="form-control" placeholder="If any">
                    </div>
                </div>
            </div>
        </div>
    </fieldset>

    <span class="clearfix"></span>

    <h3 class="col-lg-offset-1">Savours</h3>
    <fieldset class="col-sm-10 col-sm-offset-1" style="padding: 20px 50px">
        <!-- Savours-->
        <div class="col-sm-6">
            <label for="id_{{ form.salty.name }}" class="slider-label">{{ form.salty.label }}</label>

            <div class="control-group">
                <input type="number" class="form-control slider"
                       name="{{ form.salty.name }}" id="id_{{ form.salty.name }}"
                       data-slider-min="0"
                       data-slider-max="99"
                       data-slider-value="{{ form.salty.value | default_if_none:'50' }}"
                       data-slider-tooltip="hide"
                       data-slider-id="salty"
                        >
            </div>

            <div class="control-group">
                <label for="id_{{ form.sour.name }}" class="slider-label">{{ form.sour.label }}</label>
                <input type="number" class="form-control slider"
                       name="{{ form.sour.name }}" id="id_{{ form.sour.name }}"
                       data-slider-min="0"
                       data-slider-max="99"
                       data-slider-value="{{ form.sour.value | default_if_none:'50' }}"
                       data-slider-tooltip="hide"
                       data-slider-id="sour"
                        >
            </div>

            <div class="control-group">
                <label for="id_{{ form.bitter.name }}" class="slider-label">{{ form.bitter.label }}</label>
                <input type="number" class="form-control slider"
                       name="{{ form.bitter.name }}" id="id_{{ form.bitter.name }}"
                       data-slider-min="0"
                       data-slider-max="99"
                       data-slider-value="{{ form.bitter.value | default_if_none:'50' }}"
                       data-slider-tooltip="hide"
                       data-slider-id="bitter"
                        >
            </div>

            <div class="control-group">
                <label for="id_{{ form.sweet.name }}" class="slider-label">{{ form.sweet.label }}</label>
                <input type="number" class="form-control slider"
                       name="{{ form.sweet.name }}" id="id_{{ form.sweet.name }}"
                       data-slider-min="0"
                       data-slider-max="99"
                       data-slider-value="{{ form.sweet.value | default_if_none:'50' }}"
                       data-slider-tooltip="hide"
                       data-slider-id="sweet"
                        >
            </div>

            <div class="control-group">
                <label for="id_{{ form.spicy.name }}" class="slider-label">{{ form.spicy.label }}</label>
                <input type="number" class="form-control slider"
                       name="{{ form.spicy.name }}" id="id_{{ form.spicy.name }}"
                       data-slider-min="0"
                       data-slider-max="99"
                       data-slider-value="{{ form.spicy.value | default_if_none:'50' }}"
                       data-slider-tooltip="hide"
                       data-slider-id="spicy"
                        >
            </div>

            <div id="steps-div">
                <textarea id="steps" style="display:none" name="steps"></textarea>
            </div>
        </div>

        <div class="col-sm-6">
            <p class="savours-help">Savour values defines the savour of your recipe and stuff. This way we can better
                recommend people your recipe based on ther personal tastes and so on, you know. Savours are measured in
                a relative way, of course. For more information, check Wikipedia or something, dude.</p>
        </div>
    </fieldset>

    <!-- Submit Button -->
    <fieldset class="col-sm-10 col-sm-offset-1" style="padding: 20px 50px">
        <div class="form-group">
            <label for="inputDisplayName" class="col-sm-1 control-label"></label>

            <div class="col-sm-3">
                <input type="submit" class="btn btn-success" value="Publish recipe"/>
            </div>
            <div class="col-sm-3">
                <a class="btn btn-info">Save as draft</a>
            </div>
        </div>
    </fieldset>
    </form>

    <!-- Ajax uploads -->
    <form action="{% url 'upload' %}" method="post" enctype="multipart/form-data" id="upload-form"
          style="display: none">
        {% csrf_token %}
    </form>
</div>
</div>
{% endblock %}
